#!/bin/sh 
function evalrc ()
{
    if [ "$1" -ne "0" ] ; then
        echo "$2"
        exit
    fi
}

TC=tomcat6
if [ -z $TC_HOME ]; then
   TC_HOME=/var/lib/$TC
fi

if [ -z $TC_CMD ]; then
   TC_CMD="sudo /sbin/service $TC"
fi

rpm -q $TC > /dev/null
if [ "$?" -ne 0 ]; then
    TC=tomcat5
    rpm -q $TC > /dev/null
    if [ "$?" -ne 0 ]; then
       echo "DEPLOYMENT FAILED: you don't have tomcat installed"
       exit 1
    fi
fi

$TC_CMD stop

# generate the postgresql DB
if [ "$GENDB" != "" ]; then
    buildr candlepin:genschema
    evalrc $? "schema generation failed"

    dropdb -U candlepin candlepin
    evalrc $? "dropdb failed"

    createdb -U candlepin candlepin
    evalrc $? "createdb failed"

    psql -U candlepin candlepin < target/schemagen/candlepin-proxy.sql
    evalrc $? "schema creation failed"

    psql -U candlepin < code/schema/quartz/tables_postgres.sql
    evalrc $? "quartz schema failed"
fi

buildr clean package test=no

`dirname $0`/gen-certs

sudo rm -rf $TC_HOME/webapps/candlepin*
sudo cp target/candlepin-1.0.0.war $TC_HOME/webapps/candlepin.war
$TC_CMD start

sleep 10
echo "Initializing Candlepin..."
wget -qO- http://localhost:8080/candlepin/admin/init
