<?xml version="1.0" encoding="UTF-8"?>

<databaseChangeLog
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
        http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-2.0.xsd">

    <changeSet id="20150413124229-1" author="dgoodwin">
        <comment>create upstream subscription data columns on cp_pool</comment>
        <addColumn tableName="cp_pool">
            <column name="upstream_entitlement_id" type="varchar(32)"/>
            <column name="upstream_consumer_id" type="varchar(255)"/>
            <column name="upstream_pool_id" type="varchar(255)"/>
        </addColumn>
        <createIndex indexName="cp_pool_upstream_pool_id_idx" tableName="cp_pool" unique="false">
            <column name="upstream_pool_id"/>
        </createIndex>
    </changeSet>

    <!-- Don't run this on hsqldb during testing. -->
    <changeSet id="20150413124229-2" author="dgoodwin" dbms="postgresql,mysql,oracle">
        <comment>copy upstream subscription data to pools</comment>
        <sql>
            UPDATE cp_pool p SET
                upstream_entitlement_id = sub.upstream_entitlement_id,
                upstream_consumer_id = sub.upstream_consumer_id,
                upstream_pool_id = sub.upstream_pool_id
            FROM cp_pool_source_sub pss, cp_subscription sub
            WHERE
                p.id = pss.pool_id AND
                pss.subscriptionid = sub.id
        </sql>
    </changeSet>

</databaseChangeLog>
<!-- vim: set expandtab sts=4 sw=4 ai: -->
