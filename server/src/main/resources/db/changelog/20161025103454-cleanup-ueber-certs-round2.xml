<?xml version="1.0" encoding="UTF-8"?>

<databaseChangeLog
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
        http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-2.0.xsd">

   <!-- POSTGRES, ORACLE, HSQLDB QUERIES -->
   <property
        dbms="postgresql,oracle,hsqldb"
        name="delete_ueber_subs"
        value="delete from cp_subscription
               where id in (
                 select s.id from cp_subscription s
                   inner join cp_product p on s.product_id = p.id
                   left outer join cp_pool pool on pool.productid = p.id
                   where p.name LIKE '%_ueber_product'
               );"/>

    <property
        dbms="postgresql,oracle,hsqldb"
        name="delete_ueber_certs"
        value="delete from cp_ent_certificate
               where entitlement_id in (
                 select e.id from cp_entitlement e
                 inner join cp_pool p on e.pool_id = p.id
                 inner join cp_product prod on prod.id = p.productid
                 where prod.name like '%_ueber_product'
               );"/>

    <property
        dbms="postgresql,oracle,hsqldb"
        name="delete_ueber_ents"
        value="delete from cp_entitlement
               where pool_id in (
                 select p.id from cp_pool p
                 inner join cp_product prod on prod.id = p.productid
                 where prod.name like '%_ueber_product');"/>

    <property
        dbms="postgresql,oracle,hsqldb"
        name="delete_ueber_pools"
        value="delete from cp_pool
               where id in (
                 select p.id from cp_pool p
                 inner join cp_product prod on prod.id = p.productid
                 where prod.name like '%_ueber_product');"/>

    <property
        dbms="postgresql,oracle,hsqldb"
        name="delete_ueber_content"
        value="delete from cp_content
               where id in (
                 select c.id from cp_content c
                 inner join cp_product_content pc on pc.content_id = c.id
                 inner join cp_product p on p.id = pc.product_id
                 where p.name LIKE '%_ueber_product');"/>

    <property
        dbms="postgresql,oracle,hsqldb"
        name="delete_ueber_products"
        value="delete from cp_product where name like '%_ueber_product';"/>

    <property
        dbms="postgresql,oracle,hsqldb"
        name="delete_ueber_consumers"
        value="delete from cp_consumer where name = 'ueber_cert_consumer';"/>


    <!-- MYSQL QUERIES -->

    <property
        dbms="mysql"
        name="delete_ueber_subs"
        value="delete s from cp_subscription s
               inner join cp_product p on s.product_id = p.id
               left outer join cp_pool pool on pool.productid = p.id
               where p.name LIKE '%_ueber_product';"/>

    <property
        dbms="mysql"
        name="delete_ueber_certs"
        value="delete ec from cp_ent_certificate ec
               inner join cp_entitlement e on ec.entitlement_id = e.id
               inner join cp_pool p on e.pool_id = p.id
               inner join cp_product prod on prod.id = p.productid
               where prod.name like '%_ueber_product';"/>

    <property
        dbms="mysql"
        name="delete_ueber_ents"
        value="delete e from cp_entitlement e
               inner join cp_pool p on e.pool_id = p.id
               inner join cp_product prod on prod.id = p.productid
               where prod.name like '%_ueber_product';"/>

    <property
        dbms="mysql"
        name="delete_ueber_pools"
        value="delete p from cp_pool p
               inner join cp_product prod on prod.id = p.productid
               where prod.name like '%_ueber_product';"/>

    <property
        dbms="mysql"
        name="delete_ueber_content"
        value="delete c from cp_content c
               inner join cp_product_content pc on pc.content_id=c.id
               inner join cp_product p on p.id=pc.product_id
               where p.name LIKE '%_ueber_product';"/>

    <property
        dbms="mysql"
        name="delete_ueber_products"
        value="delete p from cp_product p where p.name LIKE '%_ueber_product';"/>

    <property
        dbms="mysql"
        name="delete_ueber_consumers"
        value="delete c from cp_consumer c where c.name = 'ueber_cert_consumer';"/>

    <changeSet id="20161025103454-1" author="mstead">
        <comment>Clean out all ueber cert (debug cert) data to avoid manual cleanup.
                 We are required to do this a second time since anothe issue was
                 found that would put the data in a strange state. In this case we fixed
                 up transaction management when generating ueber certs and lock the owner
                 when generating the cert.</comment>
        <sql>${delete_ueber_subs}</sql>
        <sql>${delete_ueber_certs}</sql>
        <sql>${delete_ueber_ents}</sql>
        <sql>${delete_ueber_pools}</sql>
        <sql>${delete_ueber_content}</sql>
        <sql>${delete_ueber_products}</sql>
        <sql>${delete_ueber_consumers}</sql>
    </changeSet>

</databaseChangeLog>
<!-- vim: set expandtab sts=4 sw=4 ai: -->
